name: Zoho - Refresh Access Token (every 45 min)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/45 * * * *"

jobs:
  token:
    runs-on: ubuntu-latest
    steps:
      - name: Get access token via refresh_token
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          echo "::add-mask::$CLIENT_ID"
          echo "::add-mask::$CLIENT_SECRET"
          echo "::add-mask::$REFRESH_TOKEN"

          RESPONSE=$(curl -sS -X POST "https://accounts.zoho.eu/oauth/v2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN")

          echo "===== ZOHO RESPONSE (JSON) ====="
          echo "$RESPONSE"
          echo "===== END RESPONSE ====="

          ACCESS_TOKEN=$(python - <<'PY' <<<"$RESPONSE"
import json,sys
d=json.load(sys.stdin)
print(d.get("access_token",""))
PY
          )

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: no access_token in response"; exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"
