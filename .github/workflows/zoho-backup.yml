name: Zoho - Refresh Access Token (2 tries before 02:00 UTC)

on:
  workflow_dispatch:
  schedule:
    # 2 tentatives avant le backup (qui est à 02:00 UTC)
    - cron: "45 0 * * *"   # 00:45 UTC
    - cron: "45 1 * * *"   # 01:45 UTC

jobs:
  token:
    runs-on: ubuntu-latest

    # Empêche les runs de s'empiler / se chevaucher
    concurrency:
      group: zoho-refresh-token
      cancel-in-progress: true

    # Évite qu'un run reste bloqué (et limite les effets de panne)
    timeout-minutes: 5

    steps:
      - name: Get access token via refresh_token
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          echo "::add-mask::$CLIENT_ID"
          echo "::add-mask::$CLIENT_SECRET"
          echo "::add-mask::$REFRESH_TOKEN"

          RESPONSE=$(curl -sS -X POST "https://accounts.zoho.eu/oauth/v2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN")

          echo "$RESPONSE" > response.json

          ACCESS_TOKEN=$(python3 -c "import json; d=json.load(open('response.json')); print(d.get('access_token',''))")

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: no access_token in response"
            cat response.json
            exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"

      - name: Done
        run: |
          echo "✅ Zoho access token refreshed (token masked in logs)"
