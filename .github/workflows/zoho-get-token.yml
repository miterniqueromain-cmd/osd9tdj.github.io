name: Zoho - Get Token (one shot)

on:
  workflow_dispatch:
    inputs:
      code:
        description: "Zoho grant token (starts with 1000...) valid ~10 min, one-time use"
        required: true

jobs:
  token:
    runs-on: ubuntu-latest
    steps:
      - name: Exchange code for token (PRINT CLEAR)
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          CODE: ${{ github.event.inputs.code }}
        run: |
          set -euo pipefail

          if [ -z "${CLIENT_ID}" ] || [ -z "${CLIENT_SECRET}" ] || [ -z "${CODE}" ]; then
            echo "ERROR: Missing CLIENT_ID / CLIENT_SECRET / CODE"
            exit 1
          fi

          echo "Calling Zoho token endpoint..."
          RESPONSE="$(curl -sS -X POST "https://accounts.zoho.eu/oauth/v2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=authorization_code" \
            --data-urlencode "client_id=${CLIENT_ID}" \
            --data-urlencode "client_secret=${CLIENT_SECRET}" \
            --data-urlencode "redirect_uri=https://localhost/" \
            --data-urlencode "code=${CODE}")"

          echo ""
          echo "===== ZOHO RESPONSE (JSON) ====="
          echo "${RESPONSE}"
          echo "===== END RESPONSE ====="
          echo ""

          # Fail the job if Zoho returns an error
          if echo "${RESPONSE}" | grep -q '"error"'; then
            echo "Zoho returned an error. See JSON above."
            exit 2
          fi
