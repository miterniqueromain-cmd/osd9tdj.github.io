name: Backup site (ZIP) -> Zoho WorkDrive

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # tous les jours à 02:00 UTC

jobs:
  backup:
    runs-on: ubuntu-latest

    concurrency:
      group: site-backup
      cancel-in-progress: true

    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Créer 2 archives ZIP :
      #    - site (tous les jours) SANS mp3
      #    - mp3 (uniquement le 1er du mois UTC) avec seulement les mp3 à la racine
      - name: Create ZIP backups (site daily + mp3 monthly)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p backups
          DATE=$(date -u +"%Y-%m-%d_%H-%M")

          ZIP_SITE="backups/backup_site_${DATE}.zip"
          ZIP_MP3="backups/backup_mp3_${DATE}.zip"

          # Backup du site SANS mp3 (mp3 à la racine)
          zip -r -9 "$ZIP_SITE" . \
            -x ".git/*" \
            -x ".github/*" \
            -x "backups/*" \
            -x "*.mp3"

          echo "ZIP_SITE=$ZIP_SITE" >> "$GITHUB_ENV"

          # Backup MP3 uniquement le 1er du mois (UTC)
          DAY=$(date -u +"%d")
          if [ "$DAY" = "01" ]; then
            if ls ./*.mp3 >/dev/null 2>&1; then
              zip -9 "$ZIP_MP3" ./*.mp3
              echo "ZIP_MP3=$ZIP_MP3" >> "$GITHUB_ENV"
              echo "MP3 backup created (monthly): $ZIP_MP3"
            else
              echo "No MP3 found at repo root (monthly mp3 backup skipped)."
              echo "ZIP_MP3=" >> "$GITHUB_ENV"
            fi
          else
            echo "Not the 1st of the month (UTC) -> skipping MP3 backup."
            echo "ZIP_MP3=" >> "$GITHUB_ENV"
          fi

          echo "Archives created:"
          ls -lah backups

      # 2) Récupérer un access_token Zoho via refresh_token
      - name: Get Zoho access token (refresh_token)
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          echo "::add-mask::$CLIENT_ID"
          echo "::add-mask::$CLIENT_SECRET"
          echo "::add-mask::$REFRESH_TOKEN"

          RESPONSE="$(curl -sS --fail-with-body -X POST "https://accounts.zoho.eu/oauth/v2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN")"

          ACCESS_TOKEN="$(echo "$RESPONSE" | jq -r '.access_token // empty')"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: no access_token in Zoho response"
            echo "$RESPONSE"
            exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"

      # 3) Upload du ZIP SITE (tous les jours)
      - name: Upload SITE ZIP to Zoho WorkDrive
        shell: bash
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          FOLDER_ID: ${{ secrets.ZOHO_TARGET_FOLDER_ID }}
          ZIP_FILE: ${{ env.ZIP_SITE }}
        run: |
          set -euo pipefail

          if [ -z "$FOLDER_ID" ]; then
            echo "ERROR: ZOHO_TARGET_FOLDER_ID is empty"
            exit 1
          fi

          if [ ! -f "$ZIP_FILE" ]; then
            echo "ERROR: ZIP not found: $ZIP_FILE"
            ls -lah backups || true
            exit 1
          fi

          echo "Uploading: $ZIP_FILE"
          echo "To folder_id: $FOLDER_ID"

          UPLOAD_RESPONSE="$(curl -sS --fail-with-body -X POST "https://www.zohoapis.eu/workdrive/api/v1/upload" \
            -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
            -F "parent_id=$FOLDER_ID" \
            -F "content=@$ZIP_FILE")"

          echo "===== WORKDRIVE UPLOAD RESPONSE (SITE) ====="
          echo "$UPLOAD_RESPONSE"
          echo "===== END RESPONSE ====="

      # 3bis) Upload du ZIP MP3 (uniquement le 1er du mois, si créé)
      - name: Upload MP3 ZIP to Zoho WorkDrive (monthly)
        shell: bash
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          FOLDER_ID: ${{ secrets.ZOHO_TARGET_FOLDER_ID }}
          ZIP_FILE: ${{ env.ZIP_MP3 }}
        run: |
          set -euo pipefail

          if [ -z "${ZIP_FILE:-}" ]; then
            echo "No MP3 zip to upload (skipping)."
            exit 0
          fi

          if [ ! -f "$ZIP_FILE" ]; then
            echo "MP3 ZIP not found (skipping): $ZIP_FILE"
            exit 0
          fi

          echo "Uploading: $ZIP_FILE"
          echo "To folder_id: $FOLDER_ID"

          UPLOAD_RESPONSE="$(curl -sS --fail-with-body -X POST "https://www.zohoapis.eu/workdrive/api/v1/upload" \
            -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
            -F "parent_id=$FOLDER_ID" \
            -F "content=@$ZIP_FILE")"

          echo "===== WORKDRIVE UPLOAD RESPONSE (MP3) ====="
          echo "$UPLOAD_RESPONSE"
          echo "===== END RESPONSE ====="

      # 4) Nettoyage WorkDrive : garder seulement les 20 derniers ZIP de chaque type (site + mp3)
      #    Fix important : pour lister le contenu d’un dossier, c’est /files/<folder_id>/files
      #    + pagination pour ne pas rater des fichiers si tu en as beaucoup.
      - name: Cleanup WorkDrive (keep last 20 of each)
        shell: bash
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          FOLDER_ID: ${{ secrets.ZOHO_TARGET_FOLDER_ID }}
          KEEP: "20"
        run: |
          set -euo pipefail

          if [ -z "$FOLDER_ID" ]; then
            echo "ERROR: ZOHO_TARGET_FOLDER_ID is empty"
            exit 1
          fi

          BASE_URL="https://www.zohoapis.eu/workdrive/api/v1/files/$FOLDER_ID/files"
          LIMIT=50
          OFFSET=0

          echo "Listing all files in folder_id=$FOLDER_ID (keeping last $KEEP of each)…"

          ALL_DATA="[]"

          while true; do
            URL="${BASE_URL}?page[limit]=${LIMIT}&page[offset]=${OFFSET}"
            RESP="$(curl -sS -X GET "$URL" \
              -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
              -H "Accept: application/json")"

            if ! echo "$RESP" | jq . >/dev/null 2>&1; then
              echo "ERROR: Zoho did not return JSON"
              echo "$RESP"
              exit 1
            fi

            COUNT="$(echo "$RESP" | jq '.data | length')"
            if [ "$COUNT" -eq 0 ]; then
              break
            fi

            ALL_DATA="$(jq -s '.[0] + .[1]' <(echo "$ALL_DATA") <(echo "$RESP" | jq '.data'))"
            OFFSET=$((OFFSET + LIMIT))
          done

          echo "Total files fetched: $(echo "$ALL_DATA" | jq 'length')"

          delete_by_prefix () {
            local PREFIX="$1"

            TO_DELETE_IDS="$(
              echo "$ALL_DATA" | jq -r --arg p "$PREFIX" '
                .[]
                | select(.attributes.name | test("^" + $p + "_[0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}\\.zip$"))
                | "\(.attributes.name)\t\(.id)"
              ' | sort -r | tail -n +$((KEEP+1)) | cut -f2
            )"

            if [ -z "${TO_DELETE_IDS:-}" ]; then
              echo "Nothing to delete for $PREFIX."
              return 0
            fi

            echo "Deleting old files for $PREFIX:"
            echo "$TO_DELETE_IDS"

            while read -r FILE_ID; do
              [ -z "$FILE_ID" ] && continue
              echo "Deleting $FILE_ID …"
              curl -sS -X DELETE \
                "https://www.zohoapis.eu/workdrive/api/v1/files/$FILE_ID" \
                -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
                >/dev/null
            done <<< "$TO_DELETE_IDS"
          }

          delete_by_prefix "backup_site"
          delete_by_prefix "backup_mp3"

          echo "Cleanup done."

      # 5) (Optionnel) Artifact GitHub en secours (les 2 types)
      - name: Upload backup artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: site-backup
          path: backups/backup_*.zip
