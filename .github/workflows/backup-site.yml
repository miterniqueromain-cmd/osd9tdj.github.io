name: Backup site (ZIP) -> Zoho WorkDrive

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # tous les jours à 02:00 UTC

jobs:
  backup:
    runs-on: ubuntu-latest

    concurrency:
      group: site-backup
      cancel-in-progress: true

    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Créer l’archive ZIP
      - name: Create ZIP backup
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p backups
          DATE=$(date -u +"%Y-%m-%d_%H-%M")
          ZIP="backups/backup_site_${DATE}.zip"

          zip -r "$ZIP" . \
            -x ".git/*" \
            -x ".github/*" \
            -x "backups/*"

          echo "ZIP_FILE=$ZIP" >> "$GITHUB_ENV"
          ls -lah "$ZIP"

      # 2) Récupérer un access_token Zoho via refresh_token
      - name: Get Zoho access token (refresh_token)
        shell: bash
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          echo "::add-mask::$CLIENT_ID"
          echo "::add-mask::$CLIENT_SECRET"
          echo "::add-mask::$REFRESH_TOKEN"

          RESPONSE="$(curl -sS --fail-with-body -X POST "https://accounts.zoho.eu/oauth/v2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN")"

          ACCESS_TOKEN="$(echo "$RESPONSE" | jq -r '.access_token // empty')"

          if [ -z "$ACCESS_TOKEN" ]; then
            echo "ERROR: no access_token in Zoho response"
            echo "$RESPONSE"
            exit 1
          fi

          echo "::add-mask::$ACCESS_TOKEN"
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"

      # 3) Upload du ZIP vers TON dossier Zoho WorkDrive
      - name: Upload ZIP to Zoho WorkDrive
        shell: bash
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          FOLDER_ID: ${{ secrets.ZOHO_TARGET_FOLDER_ID }}
          ZIP_FILE: ${{ env.ZIP_FILE }}
        run: |
          set -euo pipefail

          if [ -z "$FOLDER_ID" ]; then
            echo "ERROR: ZOHO_TARGET_FOLDER_ID is empty"
            exit 1
          fi

          if [ ! -f "$ZIP_FILE" ]; then
            echo "ERROR: ZIP not found: $ZIP_FILE"
            ls -lah backups || true
            exit 1
          fi

          echo "Uploading: $ZIP_FILE"
          echo "To folder_id: $FOLDER_ID"

          UPLOAD_RESPONSE="$(curl -sS --fail-with-body -X POST "https://www.zohoapis.eu/workdrive/api/v1/upload" \
            -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
            -F "parent_id=$FOLDER_ID" \
            -F "content=@$ZIP_FILE")"

          echo "===== WORKDRIVE UPLOAD RESPONSE ====="
          echo "$UPLOAD_RESPONSE"
          echo "===== END RESPONSE ====="

      # 4) Nettoyage WorkDrive: garder seulement les 20 derniers ZIP (FIX ICI)
      - name: Cleanup WorkDrive (keep last 20)
        shell: bash
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          FOLDER_ID: ${{ secrets.ZOHO_TARGET_FOLDER_ID }}
          KEEP: "20"
        run: |
          set -euo pipefail

          echo "Listing files in folder_id=$FOLDER_ID (keeping last $KEEP)…"

          LIST_URL="https://www.zohoapis.eu/workdrive/api/v1/files/$FOLDER_ID/files?filter[type]=all&page[limit]=200"

          # -g = désactive l'interprétation des crochets [] par curl
          LIST_RESPONSE="$(curl -g -sS -X GET "$LIST_URL" \
            -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN")"

          echo "===== WORKDRIVE LIST RESPONSE (debug) ====="
          echo "$LIST_RESPONSE"
          echo "===== END RESPONSE ====="

          TO_DELETE_IDS="$(
            echo "$LIST_RESPONSE" | jq -r '
              .data[]
              | select(.attributes.name | test("^backup_site_[0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}\\.zip$"))
              | "\(.attributes.name)\t\(.id)"
            ' | sort -r | tail -n +$((KEEP+1)) | cut -f2
          )"

          if [ -z "${TO_DELETE_IDS:-}" ]; then
            echo "Nothing to delete."
            exit 0
          fi

          echo "Deleting these file ids:"
          echo "$TO_DELETE_IDS"

          while read -r FILE_ID; do
            [ -z "$FILE_ID" ] && continue
            echo "Deleting $FILE_ID …"
            curl -sS -X DELETE \
              "https://www.zohoapis.eu/workdrive/api/v1/files/$FILE_ID" \
              -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
              >/dev/null
          done <<< "$TO_DELETE_IDS"

          echo "Cleanup done."
      # 5) (Optionnel) Artifact GitHub en secours
      - name: Upload backup artifact (GitHub)
        uses: actions/upload-artifact@v4
        with:
          name: site-backup
          path: backups/backup_site_*.zip
