name: Backup site (ZIP) -> Zoho WorkDrive

on:
  workflow_dispatch:
  schedule:
    - cron: "0 2 * * *"   # tous les jours à 02:00 UTC

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1️⃣ Créer l’archive ZIP
      - name: Create ZIP backup
        run: |
          set -euo pipefail
          mkdir -p backups
          DATE=$(date -u +"%Y-%m-%d_%H-%M")
          ZIP="backups/backup_site_${DATE}.zip"
          zip -r "$ZIP" . \
            -x ".git/*" \
            -x ".github/*" \
            -x "backups/*"
          echo "ZIP_FILE=$ZIP" >> "$GITHUB_ENV"

      # 2️⃣ Garder seulement les 5 derniers ZIP (local runner)
      - name: Keep only last 5 backups
        run: |
          set -euo pipefail
          ls -1t backups/backup_site_*.zip | tail -n +6 | xargs -r rm --

      # 3️⃣ Récupérer un access_token Zoho (refresh_token)
      - name: Get Zoho access token
        env:
          CLIENT_ID: ${{ secrets.ZOHO_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.ZOHO_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.ZOHO_REFRESH_TOKEN }}
        run: |
          set -euo pipefail

          RESPONSE=$(curl -sS -X POST "https://accounts.zoho.eu/oauth/v2/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            --data-urlencode "grant_type=refresh_token" \
            --data-urlencode "client_id=$CLIENT_ID" \
            --data-urlencode "client_secret=$CLIENT_SECRET" \
            --data-urlencode "refresh_token=$REFRESH_TOKEN")

          echo "$RESPONSE" > response.json

          ACCESS_TOKEN=$(python3 -c "
import json
d=json.load(open('response.json'))
print(d.get('access_token',''))
")

          if [ -z \"$ACCESS_TOKEN\" ]; then
            echo \"ERROR: no access_token\"
            cat response.json
            exit 1
          fi

          echo \"::add-mask::$ACCESS_TOKEN\"
          echo \"ACCESS_TOKEN=$ACCESS_TOKEN\" >> \"$GITHUB_ENV\"

      # 4️⃣ Upload vers TON dossier Zoho WorkDrive
      - name: Upload ZIP to Zoho WorkDrive
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          FOLDER_ID: ${{ secrets.ZOHO_TARGET_FOLDER_ID }}
          ZIP_FILE: ${{ env.ZIP_FILE }}
        run: |
          set -euo pipefail

          curl -sS -X POST "https://www.zohoapis.eu/workdrive/api/v1/upload" \
            -H "Authorization: Zoho-oauthtoken $ACCESS_TOKEN" \
            -F "parent_id=$FOLDER_ID" \
            -F "content=@$ZIP_FILE"

      # 5️⃣ (Optionnel) Artifact GitHub en secours
      - name: Upload backup artifact
        uses: actions/upload-artifact@v4
        with:
          name: site-backup
          path: backups/backup_site_*.zip
